reticulate::py_run_string("
import numpy as np
# Test sequence
test_23bp = 'ACGTGTGACTACCGGCGGCGCGG'
test_21mer = test_23bp[:21]  # 'ACGTGTGACTACCGGCGGCGC'
print(f'Input 23bp: {test_23bp}')
print(f'21-mer used: {test_21mer}')
print(f'20-mer (protospacer): {test_21mer[:20]}')
print()
# Check embedding
X_seq = make_embedding_data([test_21mer])
print(f'Embedding shape: {X_seq.shape}')
print(f'Embedding values: {X_seq[0]}')
print()
# Check biofeatures
X_bio = compute_biofeatures([test_21mer])
print(f'Biofeature shape: {X_bio.shape}')
print(f'Biofeature values:')
feature_names = ['stem', 'dG', 'dG_binding_20', 'dG_binding_7to20',
'GC>10', 'GC<10', 'GC_count',
'Tm_global', 'Tm_5mer', 'Tm_8mer', 'Tm_4mer']
for i, name in enumerate(feature_names):
print(f'  {name}: {X_bio[0, i]:.4f}')
")
mutateR:::predict_deephf_python('ACGTGTGACTACCGGCGGCGCGG', deephf_var = 'wt_u6')
devtools::uninstall()
# 6. Test ViennaRNA specifically
reticulate::py_run_string("
import RNA
seq = 'ACGUACGUACGUACGUACGU'
(structure, mfe) = RNA.fold(seq)
print(f'Structure: {structure}')
print(f'MFE: {mfe:.2f} kcal/mol')
")
# 4. Verify correct Python is active
reticulate::py_config()
# 2. Immediately unset the variable
Sys.unsetenv("RETICULATE_PYTHON")
# 3. Activate test environment
reticulate::use_condaenv("r-mutater-test", required = TRUE)
devtools::install()
# Test 1c: Test1, but finding Cas12a gRNAs with DeepCpf1 scoring and primer design for recommended gRNA pairs
library(reticulate)
activate_mutater_env()
library(mutateR)
library(BSgenome.Hsapiens.UCSC.hg38)
library(BSgenome.Drerio.UCSC.danRer11)
activate_mutater_env()
test_environment <- function() {
message("\n", strrep("=", 60))
message("TEST 1: Environment and Dependencies")
message(strrep("=", 60))
# 1A. Check Python environment
message("\n1A. Checking mutateR Python environment...")
env_ok <- check_mutater_env()
message("    Environment status: ", ifelse(env_ok, "OK", "FAILED"))
# 1B. Check ViennaRNA module
message("\n1B. Checking ViennaRNA module...")
rna_ok <- reticulate::py_module_available("RNA")
message("    ViennaRNA status: ", ifelse(rna_ok, "OK", "FAILED"))
# 1C. Test ViennaRNA functionality
message("\n1C. Testing ViennaRNA RNA folding...")
fold_ok <- tryCatch({
reticulate::py_run_string("
import RNA
seq = 'ACGUACGUACGUACGUACGU'
(structure, mfe) = RNA.fold(seq)
print(f'    Structure: {structure}')
print(f'    MFE: {mfe:.2f} kcal/mol')
")
TRUE
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
message("    RNA folding status: ", ifelse(fold_ok, "OK", "FAILED"))
# 1D. Check TensorFlow
message("\n1D. Checking TensorFlow...")
tf_ok <- reticulate::py_module_available("tensorflow")
message("    TensorFlow status: ", ifelse(tf_ok, "OK", "FAILED"))
# Summary
all_ok <- env_ok && rna_ok && fold_ok && tf_ok
message("\n", strrep("-", 40))
message("TEST 1 RESULT: ", ifelse(all_ok, "PASSED", "FAILED"))
message(strrep("-", 40))
return(all_ok)
}
test_validate_deephf <- function() {
message("\n", strrep("=", 60))
message("TEST 2: DeepHF Validation Function")
message(strrep("=", 60))
variants <- c("wt", "wt_u6", "wt_t7", "esp", "hf")
results <- list()
for (var in variants) {
message("\n2.", which(variants == var), ". Testing validate_deephf(deephf_var = '", var, "')...")
results[[var]] <- tryCatch({
validate_deephf(deephf_var = var)
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
}
# Summary
message("\n", strrep("-", 40))
message("Variant Results:")
for (var in variants) {
message("    ", var, ": ", ifelse(results[[var]], "PASSED", "FAILED"))
}
all_ok <- all(unlist(results))
message("\nTEST 2 RESULT: ", ifelse(all_ok, "PASSED", "FAILED"))
message(strrep("-", 40))
return(all_ok)
}
test_predict_deephf_direct <- function() {
message("\n", strrep("=", 60))
message("TEST 3: Direct predict_deephf_python() Calls")
message(strrep("=", 60))
# Test sequences (23bp: 20bp protospacer + 3bp PAM)
test_seqs_23bp <- c(
"ACGTGTGACTACCGGCGGCGCGG",
"GGAAGTCTGGAGTCTCCAGGTGG",
"ATCGATCGATCGATCGATCGAGG",
"GCTAGCTAGCTAGCTAGCTANGG"
)
# Test sequences (30bp: 4bp flank + 20bp protospacer + 3bp PAM + 3bp flank)
test_seqs_30bp <- c(
"AAAACGTGTGACTACCGGCGGCGCGGAAA",
"TTTTGGAAGTCTGGAGTCTCCAGGTGGCCC"
)
results <- list()
# 3A. Test 23bp input
message("\n3A. Testing with 23bp sequences...")
results[["23bp"]] <- tryCatch({
scores <- predict_deephf_python(test_seqs_23bp, deephf_var = "wt_u6")
message("    Input: ", length(test_seqs_23bp), " sequences")
message("    Output: ", length(scores), " scores")
message("    Scores: ", paste(round(scores, 4), collapse = ", "))
message("    Range: [", round(min(scores, na.rm = TRUE), 4), ", ",
round(max(scores, na.rm = TRUE), 4), "]")
length(scores) == length(test_seqs_23bp) && all(!is.na(scores))
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# 3B. Test 30bp input (should auto-trim)
message("\n3B. Testing with 30bp sequences (auto-trim)...")
results[["30bp"]] <- tryCatch({
scores <- predict_deephf_python(test_seqs_30bp, deephf_var = "wt_u6")
message("    Input: ", length(test_seqs_30bp), " sequences")
message("    Output: ", length(scores), " scores")
message("    Scores: ", paste(round(scores, 4), collapse = ", "))
length(scores) == length(test_seqs_30bp) && all(!is.na(scores))
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# 3C. Test all variants produce different scores
message("\n3C. Testing score variation across variants...")
results[["variants"]] <- tryCatch({
test_seq <- "ACGTGTGACTACCGGCGGCGCGG"
variant_scores <- sapply(c("wt", "wt_u6", "wt_t7", "esp", "hf"), function(v) {
predict_deephf_python(test_seq, deephf_var = v)
})
message("    Sequence: ", test_seq)
message("    wt:    ", round(variant_scores["wt"], 4))
message("    wt_u6: ", round(variant_scores["wt_u6"], 4))
message("    wt_t7: ", round(variant_scores["wt_t7"], 4))
message("    esp:   ", round(variant_scores["esp"], 4))
message("    hf:    ", round(variant_scores["hf"], 4))
# Check that not all scores are identical (models should differ)
unique_scores <- length(unique(round(variant_scores, 4)))
message("    Unique scores: ", unique_scores, "/5")
unique_scores > 1
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# 3D. Test empty input handling
message("\n3D. Testing empty input handling...")
results[["empty"]] <- tryCatch({
scores <- predict_deephf_python(character(0), deephf_var = "wt_u6")
message("    Empty input returned: ", length(scores), " scores")
length(scores) == 0
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# Summary
message("\n", strrep("-", 40))
message("Subtest Results:")
for (name in names(results)) {
message("    ", name, ": ", ifelse(results[[name]], "PASSED", "FAILED"))
}
all_ok <- all(unlist(results))
message("\nTEST 3 RESULT: ", ifelse(all_ok, "PASSED", "FAILED"))
message(strrep("-", 40))
return(all_ok)
}
test_score_grnas_deephf <- function() {
message("\n", strrep("=", 60))
message("TEST 4: score_grnas() with DeepHF")
message(strrep("=", 60))
# Get test data: TP53 exons and gRNA sites
message("\n4A. Preparing test data (TP53)...")
tx_info <- get_gene_info("TP53", "hsapiens")
canonical_tx <- tx_info$canonical$ensembl_transcript_id[1]
exons_gr <- get_exon_structures(canonical_tx, "hsapiens", output = "GRanges")
message("    Transcript: ", canonical_tx)
message("    Exons: ", length(exons_gr))
# Find Cas9 sites
message("\n4B. Finding Cas9 sites...")
cas9_sites <- find_cas9_sites(exons_gr, BSgenome.Hsapiens.UCSC.hg38)
message("    Sites found: ", length(cas9_sites))
# Subset for speed (test with first 20 sites)
if (length(cas9_sites) > 20) {
cas9_sites <- cas9_sites[1:20]
message("    Using subset: ", length(cas9_sites), " sites for testing")
}
results <- list()
# 4C. Test each DeepHF variant
variants <- c("wt_u6", "wt_t7", "esp", "hf")
for (var in variants) {
message("\n4C.", which(variants == var), ". Testing score_grnas(method='deephf', deephf_var='", var, "')...")
results[[var]] <- tryCatch({
scored <- score_grnas(cas9_sites, method = "deephf", deephf_var = var)
scores <- mcols(scored)$ontarget_score
method <- unique(mcols(scored)$scoring_method)
stored_var <- unique(mcols(scored)$deephf_var)
message("    Scores computed: ", sum(!is.na(scores)), "/", length(scores))
message("    Score range: [", round(min(scores, na.rm = TRUE), 4), ", ",
round(max(scores, na.rm = TRUE), 4), "]")
message("    Method stored: ", method)
message("    Variant stored: ", stored_var)
method == "deephf" && stored_var == var && sum(!is.na(scores)) > 0
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
}
# Summary
message("\n", strrep("-", 40))
message("Variant Results:")
for (var in names(results)) {
message("    ", var, ": ", ifelse(results[[var]], "PASSED", "FAILED"))
}
all_ok <- all(unlist(results))
message("\nTEST 4 RESULT: ", ifelse(all_ok, "PASSED", "FAILED"))
message(strrep("-", 40))
return(all_ok)
}
test_run_mutater_deephf <- function() {
message("\n", strrep("=", 60))
message("TEST 5: Full run_mutateR() Pipeline with DeepHF")
message(strrep("=", 60))
results <- list()
# 5A. Basic DeepHF run (default: wt_u6)
message("\n5A. Testing run_mutateR() with DeepHF (wt_u6)...")
results[["wt_u6"]] <- tryCatch({
result <- run_mutateR(
gene_id = "TP53",
species = "hsapiens",
genome = BSgenome.Hsapiens.UCSC.hg38,
nuclease = "Cas9",
score_method = "deephf",
deephf_var = "wt_u6",
design_primers = FALSE,  # Skip primers for speed
quiet = FALSE
)
message("    Gene: ", result$gene_symbol)
message("    Transcript: ", result$transcript_id)
message("    Score method: ", result$score_method)
message("    DeepHF variant: ", result$deephf_var)
message("    Scored gRNAs: ", length(result$scored_grnas))
message("    Pairs found: ", ifelse(is.null(result$pairs), 0, nrow(result$pairs)))
result$score_method == "deephf" && result$deephf_var == "wt_u6"
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# 5B. DeepHF with T7 variant (RNP context)
message("\n5B. Testing run_mutateR() with DeepHF (wt_t7)...")
results[["wt_t7"]] <- tryCatch({
result <- run_mutateR(
gene_id = "TP53",
species = "hsapiens",
genome = BSgenome.Hsapiens.UCSC.hg38,
nuclease = "Cas9",
score_method = "deephf",
deephf_var = "wt_t7",
design_primers = FALSE,
quiet = TRUE
)
message("    DeepHF variant: ", result$deephf_var)
message("    Pairs found: ", ifelse(is.null(result$pairs), 0, nrow(result$pairs)))
result$deephf_var == "wt_t7"
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# 5C. DeepHF with eSpCas9(1.1)
message("\n5C. Testing run_mutateR() with DeepHF (esp)...")
results[["esp"]] <- tryCatch({
result <- run_mutateR(
gene_id = "TP53",
species = "hsapiens",
genome = BSgenome.Hsapiens.UCSC.hg38,
nuclease = "Cas9",
score_method = "deephf",
deephf_var = "esp",
design_primers = FALSE,
quiet = TRUE
)
message("    DeepHF variant: ", result$deephf_var)
message("    Pairs found: ", ifelse(is.null(result$pairs), 0, nrow(result$pairs)))
result$deephf_var == "esp"
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# 5D. DeepHF with SpCas9-HF1
message("\n5D. Testing run_mutateR() with DeepHF (hf)...")
results[["hf"]] <- tryCatch({
result <- run_mutateR(
gene_id = "TP53",
species = "hsapiens",
genome = BSgenome.Hsapiens.UCSC.hg38,
nuclease = "Cas9",
score_method = "deephf",
deephf_var = "hf",
design_primers = FALSE,
quiet = TRUE
)
message("    DeepHF variant: ", result$deephf_var)
message("    Pairs found: ", ifelse(is.null(result$pairs), 0, nrow(result$pairs)))
result$deephf_var == "hf"
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
# Summary
message("\n", strrep("-", 40))
message("Pipeline Results:")
for (var in names(results)) {
message("    ", var, ": ", ifelse(results[[var]], "PASSED", "FAILED"))
}
all_ok <- all(unlist(results))
message("\nTEST 5 RESULT: ", ifelse(all_ok, "PASSED", "FAILED"))
message(strrep("-", 40))
return(all_ok)
}
test_recommend_deephf_model <- function() {
message("\n", strrep("=", 60))
message("TEST 6: recommend_deephf_model() Helper")
message(strrep("=", 60))
test_cases <- list(
list(delivery = "plasmid", cas9 = "wt", expected = "wt_u6"),
list(delivery = "lentiviral", cas9 = "wt", expected = "wt_u6"),
list(delivery = "rnp_ivt", cas9 = "wt", expected = "wt_t7"),
list(delivery = "rnp_synthetic", cas9 = "wt", expected = "wt_t7"),
list(delivery = "unknown", cas9 = "wt", expected = "wt_u6"),
list(delivery = "plasmid", cas9 = "espCas9", expected = "esp"),
list(delivery = "plasmid", cas9 = "Cas9-HF1", expected = "hf")
)
results <- list()
for (i in seq_along(test_cases)) {
tc <- test_cases[[i]]
test_name <- paste0(tc$delivery, "/", tc$cas9)
message("\n6.", i, ". Testing: delivery='", tc$delivery, "', cas9='", tc$cas9, "'")
message("    Expected: ", tc$expected)
results[[test_name]] <- tryCatch({
# Capture messages to avoid cluttering output
rec <- suppressMessages(
recommend_deephf_model(delivery = tc$delivery, cas9_variant = tc$cas9)
)
message("    Returned: ", rec)
rec == tc$expected
}, error = function(e) {
message("    ERROR: ", e$message)
FALSE
})
}
# Summary
message("\n", strrep("-", 40))
message("Recommendation Results:")
for (name in names(results)) {
message("    ", name, ": ", ifelse(results[[name]], "PASSED", "FAILED"))
}
all_ok <- all(unlist(results))
message("\nTEST 6 RESULT: ", ifelse(all_ok, "PASSED", "FAILED"))
message(strrep("-", 40))
return(all_ok)
}
test_scoring_comparison <- function() {
message("\n", strrep("=", 60))
message("TEST 7: DeepHF vs Other Scoring Methods Comparison")
message(strrep("=", 60))
# Get test gRNAs
message("\n7A. Preparing test gRNAs...")
tx_info <- get_gene_info("TP53", "hsapiens")
canonical_tx <- tx_info$canonical$ensembl_transcript_id[1]
exons_gr <- get_exon_structures(canonical_tx, "hsapiens", output = "GRanges")
cas9_sites <- find_cas9_sites(exons_gr, BSgenome.Hsapiens.UCSC.hg38)
# Use subset for speed
if (length(cas9_sites) > 15) {
cas9_sites <- cas9_sites[1:15]
}
message("    Test sites: ", length(cas9_sites))
# Score with multiple methods
methods <- c("ruleset1", "deephf", "deepspcas9")
scores_list <- list()
for (m in methods) {
message("\n7B. Scoring with method='", m, "'...")
scores_list[[m]] <- tryCatch({
if (m == "deephf") {
scored <- score_grnas(cas9_sites, method = m, deephf_var = "wt_u6")
} else {
scored <- score_grnas(cas9_sites, method = m)
}
mcols(scored)$ontarget_score
}, error = function(e) {
message("    ERROR: ", e$message)
rep(NA, length(cas9_sites))
})
scores <- scores_list[[m]]
message("    Mean score: ", round(mean(scores, na.rm = TRUE), 4))
message("    SD: ", round(sd(scores, na.rm = TRUE), 4))
}
# Correlation analysis
message("\n7C. Score correlations:")
if (all(sapply(scores_list, function(x) sum(!is.na(x)) > 5))) {
cor_mat <- cor(do.call(cbind, scores_list), use = "pairwise.complete.obs")
for (i in 1:(length(methods)-1)) {
for (j in (i+1):length(methods)) {
message("    ", methods[i], " vs ", methods[j], ": r = ",
round(cor_mat[i, j], 3))
}
}
}
message("\n", strrep("-", 40))
message("TEST 7 RESULT: COMPLETED (manual inspection)")
message(strrep("-", 40))
return(TRUE)
}
run_all_deephf_tests <- function() {
message("\n")
message(strrep("=", 60))
message("          mutateR DeepHF Test Suite")
message(strrep("=", 60))
message("Started: ", Sys.time())
message(strrep("=", 60))
results <- list()
# Run tests in sequence
results[["T1_Environment"]] <- test_environment()
if (results[["T1_Environment"]]) {
results[["T2_Validate"]] <- test_validate_deephf()
results[["T3_Direct"]] <- test_predict_deephf_direct()
results[["T4_ScoreGrnas"]] <- test_score_grnas_deephf()
results[["T5_Pipeline"]] <- test_run_mutater_deephf()
results[["T6_Recommend"]] <- test_recommend_deephf_model()
results[["T7_Comparison"]] <- test_scoring_comparison()
} else {
message("\nSkipping remaining tests due to environment failure.")
}
# Final Summary
message("\n")
message(strrep("=", 60))
message("                  FINAL SUMMARY")
message(strrep("=", 60))
for (name in names(results)) {
status <- ifelse(results[[name]], "PASSED", "FAILED")
message("    ", name, ": ", status)
}
total_passed <- sum(unlist(results))
total_tests <- length(results)
message(strrep("-", 40))
message("    Total: ", total_passed, "/", total_tests, " tests passed")
message(strrep("=", 60))
message("Completed: ", Sys.time())
message(strrep("=", 60))
return(invisible(results))
}
quick_test_deephf <- function() {
message("Quick DeepHF Test")
message(strrep("-", 40))
# Single validation
message("1. Validating DeepHF (wt_u6)...")
v1 <- validate_deephf("wt_u6")
# Single prediction
message("\n2. Single prediction test...")
scores <- predict_deephf_python(
c("ACGTGTGACTACCGGCGGCGCGG", "GGAAGTCTGGAGTCTCCAGGTGG"),
deephf_var = "wt_u6"
)
message("   Scores: ", paste(round(scores, 4), collapse = ", "))
# Quick pipeline
message("\n3. Quick pipeline test...")
result <- run_mutateR(
gene_id = "TP53",
species = "hsapiens",
genome = BSgenome.Hsapiens.UCSC.hg38,
nuclease = "Cas9",
score_method = "deephf",
deephf_var = "wt_u6",
design_primers = FALSE,
quiet = TRUE
)
message("   Pairs found: ", nrow(result$pairs))
message("\n", strrep("-", 40))
message("Quick test completed!")
return(invisible(TRUE))
}
quick_test_deephf()
